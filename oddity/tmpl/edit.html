<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oddity Editor - Fixed Layout</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/overtype/dist/overtype.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css"
          integrity="sha512-uf06llspW44/LZpHzHT6qBOIVODjWtv4MxCricRxkzvopAlSWnTf6hpZTFxuuZcuNE9CBQhqE0Seu1CoRk84nQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
{{/*    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/base16-light.min.css"*/}}
{{/*          integrity="sha512-UCcyAfcA/pJ4lD8YMo+fhwFdJeGNN5QrBlHvTQ1BopVjHWh35HD2JRV3tbwxtabH5ymri426oTfa1UF9Z63B3g=="*/}}
{{/*          crossorigin="anonymous" referrerpolicy="no-referrer"/>*/}}

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/duotone-light.min.css" integrity="sha512-xf8h6rqzUr4ZJBR/GKic+RSPJUHjPF1cFe6kGi5vgrTbcqIaRd4VaeniV/d8oM7ln5tSIV7KrQ5DxdeYO6zeCg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"
            integrity="sha512-8RnEqURPUc5aqFEN04aQEiPlSAdE0jlFS/9iGgUyNtwFnSKCXhmB6ZTNl7LnDtDWKabJIASzXrzD0K+LYexU9g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'mono': ['SF Mono', 'JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'pulse-once': 'pulse-once 1.5s ease-in-out'
                    },
                    keyframes: {
                        'pulse-once': {
                            '0%, 100%': { opacity: '0.5' },
                            '50%': { opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Diff HTML styling */
        .diff {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            line-height: 1.4;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        .diff-item {
            display: block;
        }
        
        .diff-insert {
            background-color: #d4edda;
            color: #155724;
            border-left: 3px solid #28a745;
            padding-left: 4px;
            margin: 0px 0;
            display: block;
        }
        
        .diff-delete {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 3px solid #dc3545;
            padding-left: 4px;
            margin: 0px 0;
            display: block;
        }
        
        .diff-equal {
            color: #6c757d;
            display: block;
            margin: 0px 0;
            padding-left: 4px;
        }

        .summary-gray {
            color: #6c757d;
            font-weight: bold;
        }
        .summary-inserts {
            color: #28a745;
            font-weight: bold;
        }
        .summary-deletes {
            color: #dc3545;
            font-weight: bold;
        }

        /* Fade navigation and sidebar on hover */
        .nav-fade {
            opacity: 0.4;
            transition: opacity 0.3s ease-in-out;
        }
        
        .nav-fade:hover {
            opacity: 1;
        }
        
        .sidebar-fade {
            opacity: 0.5;
            transition: opacity 0.3s ease-in-out;
        }
        
        .sidebar-fade:hover {
            opacity: 1;
        }

        #codemirrorEditor {
            /*font-family: 'JetBrains Mono', monospace;*/
            font-family: "SF Mono", SFMono-Regular, 'JetBrains Mono', Menlo, Monaco, "Cascadia Code", Consolas, "Roboto Mono", "Noto Sans Mono", "Droid Sans Mono", "Ubuntu Mono", "DejaVu Sans Mono", "Liberation Mono", "Courier New", Courier, monospace !important;
            /*font-size: 14px;*/
            /*line-height: 1.5;*/
            height: auto;
        }
        .CodeMirror pre.CodeMirror-line {
            font-family: "SF Mono", SFMono-Regular, Menlo, Monaco, "Cascadia Code", Consolas, "Roboto Mono", "Noto Sans Mono", "Droid Sans Mono", "Ubuntu Mono", "DejaVu Sans Mono", "Liberation Mono", "Courier New", Courier, monospace;
        }
        .CodeMirror {
          /*border: 1px solid #eee;*/
          height: auto;
            font-size: 14px;
        }

        .cm-content, .cm-gutter { min-height: 600px; }
        .cm-gutters { margin: 1px; }
        .cm-scroller { overflow: auto; }
        .cm-wrap { border: 1px solid silver }
        .CodeMirror-linenumber { background: rgba(247, 247, 247, 0.47); color: #e2e2e2; padding: 0 8px; border-right: 0; }
        .cm-editor {
                  /*font-family: "SF Mono", SFMono-Regular, Menlo, Monaco, "Cascadia Code", Consolas, "Roboto Mono", "Noto Sans Mono", "Droid Sans Mono", "Ubuntu Mono", "DejaVu Sans Mono", "Liberation Mono", "Courier New", Courier, monospace !important;*/
        }

    </style>
        <style>
        /* Scoped Overtype-inspired styling - no global pollution */
        .overtype-editor-app {
            /* Solar theme colors (Overtype's default) - scoped to this component */
            --oe-bg-primary: #ffffff;
            --oe-bg-secondary: #ffffff;
            --oe-text: #0d3b66;
            --oe-text-secondary: #5a7a9b;
            --oe-h1: #f95738;
            --oe-h2: #ee964b;
            --oe-h3: #3d8a51;
            --oe-strong: #ee964b;
            --oe-em: #f95738;
            --oe-link: #0d3b66;
            --oe-code: #0d3b66;
            --oe-code-bg: rgba(244, 211, 94, 0.4);
            --oe-syntax-marker: rgba(13, 59, 102, 0.52);
            --oe-cursor: #f95738;
            --oe-selection: rgba(244, 211, 94, 0.4);
            --oe-border: rgba(13, 59, 102, 0.15);

            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 1200px;
            padding: 5px 0px;
            background: var(--oe-bg-primary);
            color: var(--oe-text);
            line-height: 1.6;
        }

        .overtype-editor-app .editor-container {
            border: 1px solid var(--oe-border);
            border-radius: 8px;
            overflow: hidden;
            background: var(--oe-bg-secondary);
            box-shadow: 0 2px 8px rgba(13, 59, 102, 0.1);
        }

        /* Overtype's monospace font stack - scoped */
        .overtype-editor-app .CodeMirror {
            height: auto;
            font-family: "SF Mono", SFMono-Regular, Menlo, Monaco, "Cascadia Code", Consolas, "Roboto Mono", "Noto Sans Mono", "Droid Sans Mono", "Ubuntu Mono", "DejaVu Sans Mono", "Liberation Mono", "Courier New", Courier, monospace;
            font-size: 14px;
            line-height: 1.6;
            font-variant-ligatures: none;
            font-kerning: none;
            background: var(--oe-bg-secondary) !important;
            color: var(--oe-text) !important;
            border: none;
            /*min-height: 600px;*/
        }

        .overtype-editor-app .CodeMirror-scroll {
            min-height: 600px;
        }

        /* CodeMirror cursor styling - scoped */
        .overtype-editor-app .CodeMirror-cursor {
            border-left: 2px solid var(--oe-cursor) !important;
        }

        /* CodeMirror selection styling - scoped */
        .overtype-editor-app .CodeMirror-selected {
            background: var(--oe-selection) !important;
        }

        /* Overtype-inspired syntax highlighting - scoped */
        .overtype-editor-app .cm-header-1 {
            color: var(--oe-h1) !important;
            font-weight: bold !important;
        }
        .overtype-editor-app .cm-header-2 {
            color: var(--oe-h2) !important;
            font-weight: bold !important;
        }
        .overtype-editor-app .cm-header-3 {
            color: var(--oe-h3) !important;
            font-weight: bold !important;
        }

        .overtype-editor-app .cm-strong {
            color: var(--oe-strong) !important;
            font-weight: bold !important;
        }

        .overtype-editor-app .cm-em {
            color: var(--oe-em) !important;
            font-style: italic !important;
        }

        .overtype-editor-app .cm-link {
            color: var(--oe-link) !important;
            text-decoration: underline !important;
        }

        .overtype-editor-app .cm-url {
            color: var(--oe-text-secondary) !important;
            opacity: 0.7;
        }

        .overtype-editor-app .cm-comment {
            color: var(--oe-code) !important;
            background: var(--oe-code-bg) !important;
            border-radius: 2px;
            padding: 1px 2px;
        }

        /* Markdown syntax markers - scoped */
        .overtype-editor-app .cm-formatting {
            color: var(--oe-syntax-marker) !important;
            opacity: 0.7 !important;
        }

        .overtype-editor-app .cm-quote {
            color: var(--oe-text-secondary) !important;
        }

        .overtype-editor-app .cm-list {
            color: var(--oe-strong) !important;
        }

        .overtype-editor-app .preview {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid var(--oe-border);
            border-radius: 8px;
            background-color: var(--oe-bg-secondary);
            font-family: Georgia, 'Times New Roman', serif;
            line-height: 1.8;
            color: var(--oe-text);
        }

        .overtype-editor-app .preview h1,
        .overtype-editor-app .preview h2,
        .overtype-editor-app .preview h3 {
            font-weight: 600;
            margin: 1em 0 0.5em 0;
        }

        .overtype-editor-app .preview h1 { color: var(--oe-h1); font-size: 2em; }
        .overtype-editor-app .preview h2 { color: var(--oe-h2); font-size: 1.5em; }
        .overtype-editor-app .preview h3 { color: var(--oe-h3); font-size: 1.17em; }

        .overtype-editor-app .preview strong { color: var(--oe-strong); }
        .overtype-editor-app .preview em { color: var(--oe-em); }
        .overtype-editor-app .preview a { color: var(--oe-link); }

        .overtype-editor-app .preview code {
            background: var(--oe-code-bg);
            color: var(--oe-code);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: "SF Mono", SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.9em;
        }

        .overtype-editor-app .preview pre {
            background: var(--oe-code-bg);
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
        }

        .overtype-editor-app .preview blockquote {
            border-left: 4px solid var(--oe-text-secondary);
            padding-left: 1em;
            margin-left: 0;
            color: var(--oe-text-secondary);
            font-style: italic;
        }

        .overtype-editor-app .controls {
            margin-bottom: 20px;
        }

        .overtype-editor-app button {
            margin-right: 10px;
            padding: 10px 16px;
            border: 1px solid var(--oe-border);
            background-color: var(--oe-bg-secondary);
            color: var(--oe-text);
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .overtype-editor-app button:hover {
            background-color: var(--oe-bg-primary);
            border-color: var(--oe-strong);
            color: var(--oe-strong);
        }

        .overtype-editor-app button:active {
            transform: translateY(1px);
        }

        .overtype-editor-app .character-count {
            font-family: "SF Mono", SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.85rem;
            color: var(--oe-text-secondary);
        }

        /* Enhanced light theme styling - scoped */
        .overtype-editor-app h1,
        .overtype-editor-app h2,
        .overtype-editor-app h3 {
            color: var(--oe-text);
            font-weight: 600;
            margin: 1.5em 0 0.5em 0;
        }

        .overtype-editor-app h1 {
            color: var(--oe-h1);
            font-size: 2.25em;
            border-bottom: 2px solid var(--oe-border);
            padding-bottom: 0.3em;
        }

        .overtype-editor-app h2 {
            color: var(--oe-h2);
            font-size: 1.75em;
        }

        .overtype-editor-app h3 {
            color: var(--oe-h3);
            font-size: 1.25em;
        }

        /* Beautiful focus states - scoped */
        .overtype-editor-app .CodeMirror-focused {
            /*box-shadow: 0 0 0 2px var(--oe-selection);*/
        }

        .overtype-editor-app button:focus {
            outline: 2px solid var(--oe-cursor);
            outline-offset: 2px;
        }
    </style>
</head>
<body class="font-mono bg-white min-h-screen">
    <div id="app">
        <!-- Navigation Bar -->
        <div class="py-1 border-b-0 border-gray-100 nav-fade" :class="{ 'nav-fade': !distractionFree }">
            <div :class="'mx-auto px-2 pt-2 pb-2 flex flex-col lg:flex-row items-start lg:items-center lg:justify-between gap-2 ' + editorWidthOptions[editorWidth].containerClass">
                <!-- Left: Navigation Links -->
                <div class="flex gap-1 flex-wrap justify-center lg:justify-start" >
                    <a v-for="link in navLinks" :key="link.name" :href="link.href" :target="link.target"  v-if="!distractionFree"
                       class="text-gray-600 text-xs px-1 py-1 rounded hover:bg-gray-100 hover:text-gray-900 transition-colors"
                       :class="{ 'bg-blue-600 text-white hover:bg-blue-700 hover:text-white': link.primary }">
                        [[ link.name ]]
                    </a>
                    <span v-if="!distractionFree" class="text-xs text-gray-400 px-1 py-1 hidden lg:inline">|</span>
                    <input  v-if="!distractionFree" type="text" value="/{{.NewPostHintSlug}}" id="new-post-hint"
                      class="text-xs px-2 py-1 border border-gray-300 rounded bg-gray-50 text-gray-500 cursor-pointer w-full max-w-60 lg:w-60" />

                    <input  v-if="!distractionFree"  type="button" value="Add"
                      onclick="location.href='/admin/edit?path=' + document.getElementById('new-post-hint').value"
                      class="text-xs px-2 py-1 border border-gray-300 rounded bg-gray-100 text-gray-600 hover:bg-gray-200 cursor-pointer" />
                    <a  v-if="!distractionFree" href="/auth" class="text-xs px-2 py-1 border border-gray-300 rounded bg-gray-100 text-gray-600 hover:bg-gray-200 cursor-pointer">
                        Auth
                    </a>
                    <a  v-if="!distractionFree" href="/auth/logout" class="text-xs px-2 py-1 border border-gray-300 rounded bg-gray-100 text-gray-600 hover:bg-gray-200 cursor-pointer">
                        Logout
                    </a>
                </div>

                <!-- Right: Controls -->
                <div class="flex gap-1 justify-center">
                    <button @click="toggleSidebar"
                            class="bg-white border border-gray-300 rounded px-2 py-1 text-xs text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all">
                        [[ sidebarVisible ? '‚úï' : '‚â°' ]]
                    </button>
                    <button @click="toggleSidebarPosition"
                            class="bg-white border border-gray-300 rounded px-2 py-1 text-xs text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all"
                            title="Move sidebar below content">
                        [[ sidebarBelow ? '‚Üë' : '‚Üì' ]]
                    </button>
                    <button @click="cycleEditorWidth"
                            class="bg-white border border-gray-300 rounded px-2 py-1 text-xs text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all"
                            :title="'Editor width: ' + editorWidthOptions[editorWidth].label">
                        [[ editorWidthOptions[editorWidth].icon ]]
                    </button>
                    <button @click="toggleDistractionFree"
                            class="bg-white border border-gray-300 rounded px-2 py-1 text-xs text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all">
                        [[ distractionFree ? '‚óë' : '‚óê' ]]
                    </button>
                    <button @click="saveContent"
                            class="bg-white border border-gray-300 rounded px-2 py-1 text-xs text-green-600 hover:text-white hover:bg-green-600 transition-all">
                        üíæ
                    </button>
                </div>
            </div>
        </div>

        <!-- Title Bar -->
        <div class="py-4">
            <div :class="'mx-auto px-4 ' + editorWidthOptions[editorWidth].containerClass">
                <span class="text-sm text-gray-500" :class="{ 'text-gray-200 hover:text-gray-500': distractionFree }">Editing: [[ currentFile ]]</span>
                <span v-if="lastSaved" :key="lastSaved" class="text-xs text-gray-500 ml-4 animate-pulse-once">Last saved: [[ lastSaved ]]</span>
            </div>
        </div>

        <!-- Main Content -->
        <div :class="'mx-auto px-4 flex flex-col gap-6 ' + editorWidthOptions[editorWidth].containerClass + (!sidebarBelow ? ' lg:flex-row' : ' lg:flex-col')">
            <!-- Editor Area -->
            <div class="flex-1 border-t border-solid" :class="{
                    'border-gray-100': distractionFree,
                    'border-gray-300': !distractionFree && !isPrivate,
                    'border-orange-300': !distractionFree && isPrivate,
                    'border-orange-100': distractionFree && isPrivate,
                }">
                <!--div id="richeditor" class="w-full richeditor"></div-->
                <div id="richeditor2" class="w-full richeditor2 tracking-normal overtype-editor-app">
                    <textarea
                        id="codemirrorEditor"
                        v-model="content"
                        ref="codemirrorEditor"
                        @input="autoResize"
                        class="w-full overtype-editor-app min-h-[600px] lg:min-h-[60vh] border-none p-4 text-sm lg:text-sm text-base leading-relaxed resize-none outline-none bg-transparent font-mono tracking-normal"
                        :class="{ 'bg-gray-50 focus:bg-white': !distractionFree }"
                        :placeholder="editorPlaceholder"
                        spellcheck="true"
                    ></textarea>

                </textarea>
                </div>

            </div>

            <!-- Sidebar -->
            <div v-if="sidebarVisible && !distractionFree" 
                 class="w-full flex-shrink-0 border-t pt-6 sidebar-fade" 
                 :class="{ 
                     'lg:w-64 lg:border-t-0 lg:pt-0': !sidebarBelow,
                     'lg:w-full lg:mx-auto lg:border-t lg:pt-6': sidebarBelow
                 }">
                
                <!-- Navigation Section -->
                <div class="mb-6" v-if="navigationItems.length > 0">
                    <h3 @click="toggleSection('navigation')"
                        class="text-xs uppercase text-gray-600 font-semibold mb-3 cursor-pointer flex items-center justify-between hover:text-gray-900">
                        Navigation
                        <span class="text-xs transition-transform" :class="{ 'rotate-180': !sections.navigation }">‚ñº</span>
                    </h3>
                    <div v-show="sections.navigation" class="space-y-1">
                        <a v-for="navItem in navigationItems" :key="navItem.name" :href="navItem.href" :target="navItem.target"
                           class="block text-gray-600 text-xs px-2 py-1 rounded hover:bg-gray-100 hover:text-gray-900 transition-colors no-underline"
                           :class="{ 'bg-blue-600 text-white hover:bg-blue-700 hover:text-white': navItem.primary }">
                            [[ navItem.emoji ]] [[ navItem.name ]]
                        </a>
                    </div>
                </div>

                <!-- Front Matter Section -->
                <div class="mb-6">
                    <h3 @click="toggleSection('frontmatter')" 
                        class="text-xs uppercase text-gray-600 font-semibold mb-3 cursor-pointer flex items-center justify-between hover:text-gray-900">
                        Front Matter
                        <span class="text-xs transition-transform" :class="{ 'rotate-180': !sections.frontmatter }">‚ñº</span>
                    </h3>
                    <div v-show="sections.frontmatter">
                        <textarea v-model="frontmatter"
                                  @input="updateFrontmatter"
                                  class="w-full h-24 text-xs border border-gray-200 p-2 font-mono resize-y outline-none bg-gray-50 focus:border-blue-500 rounded"
                                  placeholder="title: My Post&#10;tags: [blog, markdown]&#10;date: 2024-01-01&#10;public: true">
                        </textarea>
                        <div v-if="frontmatter === ''" class="text-xs text-gray-400 mt-1">Frontmatter is empty</div>
                    </div>
                </div>

                <!-- File Upload Section -->
                <div class="mb-6">
                    <h3 @click="toggleSection('fileupload')" 
                        class="text-xs uppercase text-gray-600 font-semibold mb-3 cursor-pointer flex items-center justify-between hover:text-gray-900">
                        File Upload
                        <span class="text-xs transition-transform" :class="{ 'rotate-180': !sections.fileupload }">‚ñº</span>
                    </h3>
                    <div v-show="sections.fileupload">
                        <!-- Upload Area -->
                        <div @click="triggerFileInput" @drop="handleDrop" 
                             @dragover.prevent="isDragOver = true" 
                             @dragenter.prevent="isDragOver = true" 
                             @dragleave.prevent="isDragOver = false"
                             class="border-2 border-dashed border-gray-300 p-3 text-center text-gray-600 mb-3 cursor-pointer bg-gray-50 text-xs hover:border-blue-500 hover:bg-blue-50 transition-colors rounded"
                             :class="{ 'border-blue-500 bg-blue-50 text-blue-600': isDragOver }">
                            Drop files here or click to select
                        </div>
                        <input ref="fileInput" type="file" multiple class="hidden" @change="handleFileSelect">
                        
                        <!-- Upload Progress -->
                        <div v-if="uploading" class="mb-3 text-xs text-blue-600">
                            Uploading... [[ uploadProgress ]]%
                        </div>
                        
                        <!-- Pending Files (before upload) -->
                        <div v-if="pendingFiles.length > 0" class="mb-3">
                            <div class="text-xs text-gray-600 mb-2">Files ready for upload:</div>
                            <div class="space-y-2">
                                <div v-for="file in pendingFiles" :key="file.id" class="bg-gray-50 border border-gray-200 rounded p-2">
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs font-semibold" :class="{ 'text-blue-600': file.type === 'image', 'text-gray-600': file.type === 'file' }">
                                            [[ file.type === 'image' ? '[IMG]' : '[FILE]' ]] [[ file.name ]]
                                        </span>
                                        <button @click="removePendingFile(file.id)" class="text-xs text-red-600 hover:text-red-800">√ó</button>
                                    </div>
                                    
                                    <!-- Image resize controls for pending images -->
                                    <div v-if="file.type === 'image'" class="mt-2">
                                        <div class="flex gap-1 items-center">
                                            <input v-model="file.resizeWidth" type="number" placeholder="Width" class="w-16 p-1 border border-gray-300 rounded text-xs">
                                            <input v-model="file.resizeHeight" type="number" placeholder="Height" class="w-16 p-1 border border-gray-300 rounded text-xs">
                                            <span class="text-xs text-gray-500">(optional)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button @click="uploadPendingFiles" class="mt-2 px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700" :disabled="uploading">
                                Upload [[ pendingFiles.length ]] file[[ pendingFiles.length > 1 ? 's' : '' ]]
                            </button>
                        </div>
                        
                        <!-- File List -->
                        <div class="space-y-1">
                            <div v-for="file in files" :key="file.id" class="group">
                                <div class="flex items-center justify-between p-1 hover:bg-gray-50 rounded">
                                    <span @click="insertFileLink(file)" class="text-xs cursor-pointer flex-1 text-gray-700 hover:text-gray-900">
                                        <span class="font-semibold" :class="{ 'text-blue-600': file.type === 'image', 'text-gray-600': file.type === 'file' }">
                                            [[ file.type === 'image' ? '[IMG]' : '[FILE]' ]]
                                        </span>
                                        [[ file.name ]]
                                    </span>
                                    <button @click="toggleFileMenu(file.id)" 
                                            class="text-xs text-gray-400 hover:text-gray-600 px-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        ‚ãØ
                                    </button>
                                </div>
                                
                                <!-- File Menu -->
                                <div v-show="file.menuOpen" class="mt-1 bg-gray-50 border border-gray-200 rounded p-1">
                                    <div @click="renameFile(file)" class="text-xs p-2 cursor-pointer hover:bg-gray-100 border-b border-gray-100">Rename</div>
                                    <div @click="deleteFile(file.id)" class="text-xs p-2 cursor-pointer hover:bg-gray-100 text-red-600" :class="{ 'border-b border-gray-100': file.type === 'image' }">Delete</div>
                                    <div v-if="file.type === 'image'" @click="toggleImageResize(file.id)" class="text-xs p-2 cursor-pointer hover:bg-gray-100">
                                        [[ file.resizeOpen ? 'Hide Resize' : 'Resize' ]]
                                    </div>
                                </div>

                                <!-- Image Resize Controls -->
                                <div v-if="file.type === 'image' && file.resizeOpen" class="mt-1 p-2 bg-gray-50 rounded border border-gray-200">
                                    <div class="flex gap-1 items-center">
                                        <input v-model="file.resizeWidth" type="number" placeholder="Width" class="w-16 p-1 border border-gray-300 rounded text-xs">
                                        <input v-model="file.resizeHeight" type="number" placeholder="Height" class="w-16 p-1 border border-gray-300 rounded text-xs">
                                        <button @click="applyImageResize(file)" class="px-2 py-1 bg-blue-600 text-white border-none rounded text-xs cursor-pointer hover:bg-blue-700">Apply</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Page Search Section -->
                <div class="mb-6" v-if="false">
                    <h3 @click="toggleSection('search')" 
                        class="text-xs uppercase text-gray-600 font-semibold mb-3 cursor-pointer flex items-center justify-between hover:text-gray-900">
                        Page Search
                        <span class="text-xs transition-transform" :class="{ 'rotate-180': !sections.search }">‚ñº</span>
                    </h3>
                    <div v-show="sections.search">
                        <input v-model="searchQuery" @input="performSearch" type="text" placeholder="Search pages..." 
                               class="w-full p-2 border border-gray-200 text-xs font-mono outline-none bg-gray-50 focus:border-blue-500 rounded mb-3">
                        
                        <div class="space-y-1">
                            <div v-for="result in filteredSearchResults" :key="result.id" @click="insertPageLink(result)"
                                 class="text-xs p-1 cursor-pointer hover:bg-gray-50 rounded text-gray-700 hover:text-gray-900">
                                <span class="font-semibold text-green-600">[PAGE]</span>
                                [[ result.title ]]
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Diffs Section -->
                <div class="mb-6">
                    <h3 @click="toggleSection('history')" 
                        class="text-xs uppercase text-gray-600 font-semibold mb-3 cursor-pointer flex items-center justify-between hover:text-gray-900">
                        History
                        <span v-if="historyLoading" class="text-xs text-gray-400">‚Üª</span>
                        <span class="text-xs transition-transform" :class="{ 'rotate-180': !sections.history }">‚ñº</span>
                    </h3>
                    <div v-show="sections.history">
                        <div v-if="historyError" class="text-xs text-red-500 p-2 mb-2">[[ historyError ]]</div>
                        <div v-if="!historyLoading && history.length === 0" class="text-xs text-gray-500 p-2">No history available</div>
                        <div v-if="history.length > 0" class="space-y-2">
                            <div v-for="(item, index) in history" :key="index" class="border border-gray-200 rounded">
                                <div @click="toggleHistoryItem(index)" 
                                     class="p-3 cursor-pointer hover:bg-gray-50 flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="text-xs font-medium text-gray-800">[[ item.title || 'Change' ]]</div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            [[ formatDate(item.createdAt) ]]
                                            <span v-if="item.deltaSummary" class="ml-2" v-html="item.deltaSummary"></span>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-400 transition-transform" 
                                          :class="{ 'rotate-180': item.expanded }">‚ñº</span>
                                </div>
                                <div v-show="item.expanded" class="border-t border-gray-200 p-3 bg-gray-50">
                                    <div v-if="item.diffHTML" v-html="item.diffHTML" class="text-xs font-mono overflow-x-auto"></div>
                                    <div v-else class="text-xs text-gray-500">No diff available</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <script>
        // Configuration constants
        const CONFIG = {
            DEFAULT_IMAGE_WIDTH: 1600,
            DEFAULT_IMAGE_HEIGHT: 2400,
            UPLOAD_TIMEOUT: 120000, // 2 minutes
            MAX_FILE_SIZE: 50 * 1024 * 1024, // 50MB
            SUPPORTED_IMAGE_TYPES: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
            EDITOR_MIN_HEIGHT: 600
        };

        function tryJSON(input, defaultObj) {
            if (input === "") {
                return defaultObj
            }
            try {
                return JSON.parse(input)
            } catch (e) {
                console.log("Error parsing json", e)
                return defaultObj
            }
        }


        var defaultLoadedData = tryJSON("{{.Data}}", {});


        var overtypeEditor = null;
        var codemirrorEditor = null;
        // document on load
        document.addEventListener("DOMContentLoaded", function() {
            // Create a single editor
            const OT = window.OverType.default || window.OverType;
            if(document.getElementsByClassName("richeditor").length > 0) {
                // document.getElementsByClassName("editorboxreal")[0].style.display = 'none';
                overtypeEditor = new OT(".richeditor", {
                    value: defaultLoadedData.content || '',
                    theme: "light",
                    autoResize: true,
                    fontSize: '14px',
                    smartLists: false,
                    tabSize: 4,
                    minHeight: CONFIG.EDITOR_MIN_HEIGHT + 'px',
                    onChange: (value) => {
                        app.content = value;
                    },
                    textAreaProps: {
                        spellcheck: 'true',
                        lang: 'en',
                    }
                });

                for (var i = 0; i < overtypeEditor.length; i++) {
                    // overtypeEditor[i].textarea.setAttribute('autocomplete', 'on');
                    // overtypeEditor[i].textarea.setAttribute('autocorrect', 'on');
                    // overtypeEditor[i].textarea.setAttribute('autocapitalize', 'on');
                    // overtypeEditor[i].textarea.setAttribute('spellcheck', 'true');
                    // overtypeEditor[i].textarea.setAttribute('data-gramm', 'true');
                    // overtypeEditor[i].textarea.setAttribute('data-gramm_editor', 'true');
                    // overtypeEditor[i].textarea.setAttribute('data-enable-grammarly', 'true');
                    
                    // Add paste event listener for image paste
                    overtypeEditor[i].textarea.addEventListener('paste', function(e) {
                        app.handlePaste(e);
                    });
                }

            }

            // setup codemirror if it exists
            if(document.getElementById("codemirrorEditor")) {
                codemirrorEditor = CodeMirror.fromTextArea(document.getElementById("codemirrorEditor"), {
                    mode: 'markdown',
                    lineNumbers: false,
                    lineWrapping: true,
                    theme: 'default',
                    tabSize: 4,
                    indentUnit: 4,
                    spellcheck: true,
                    autocorrect: true,
                    autocapitalize: true,
                    viewportMargin: Infinity,
                    scrollBarStyle: 'native',
                    // auto expand

                    extraKeys: {
                        'Tab': function(cm) {
                            if (cm.somethingSelected()) {
                                cm.indentSelection("add");
                            } else {
                                cm.replaceSelection("    ", "end");
                            }
                        },
                        'Shift-Tab': function(cm) {
                            if (cm.somethingSelected()) {
                                cm.indentSelection("subtract");
                            } else {
                                var cursor = cm.getCursor();
                                var line = cm.getLine(cursor.line);

                                // Check if this is a list line
                                var listMatch = line.match(/^(\s*)([-*+]|\d+\.)\s+(.*)$/);
                                if (listMatch) {
                                    var [, indent, marker, content] = listMatch;
                                    var currentIndent = indent.length;
                                    var newIndent = Math.max(0, currentIndent - 4);
                                    var newLine = " ".repeat(newIndent) + marker + ' ' + content;

                                    var from = { line: cursor.line, ch: 0 };
                                    var to = { line: cursor.line, ch: line.length };
                                    cm.replaceRange(newLine, from, to);

                                    // Maintain cursor position relative to content
                                    var newCursorPos = newIndent + marker.length + 1 + (cursor.ch - (currentIndent + marker.length + 1));
                                    cm.setCursor(cursor.line, Math.max(newIndent + marker.length + 1, newCursorPos));
                                } else {
                                    // Non-list line - use your original logic
                                    var from = { line: cursor.line, ch: 0 };
                                    var to = { line: cursor.line, ch: line.length };
                                    var currentIndent = line.match(/^\s*/)[0].length;
                                    var newIndent = Math.max(0, currentIndent - 4);
                                    cm.replaceRange(" ".repeat(newIndent) + line.substring(currentIndent), from, to);
                                }
                            }
                        },
                        'Enter': function(cm) {
                            const cursor = cm.getCursor();
                            const line = cm.getLine(cursor.line);

                            // Check for bullet list patterns
                            const bulletMatch = line.match(/^(\s*)([-*+])\s+(.*)$/);
                            const numberedMatch = line.match(/^(\s*)(\d+)\.\s+(.*)$/);

                            if (bulletMatch) {
                                const [, indent, bullet, content] = bulletMatch;
                                if (content.trim() === '') {
                                    // Empty list item - exit list
                                    cm.replaceRange('', {line: cursor.line, ch: 0}, {line: cursor.line, ch: line.length});
                                } else {
                                    // Create new list item at same level
                                    cm.replaceSelection('\n' + indent + bullet + ' ');
                                }
                                return;
                            }

                            if (numberedMatch) {
                                const [, indent, num, content] = numberedMatch;
                                if (content.trim() === '') {
                                    // Empty numbered item - exit list
                                    cm.replaceRange('', {line: cursor.line, ch: 0}, {line: cursor.line, ch: line.length});
                                } else {
                                    // Create new numbered item (increment number)
                                    const nextNum = parseInt(num) + 1;
                                    cm.replaceSelection('\n' + indent + nextNum + '. ');
                                }
                                return;
                            }

                            // Default Enter behavior for non-list lines
                            return CodeMirror.Pass;
                        },
                        'Ctrl-S': function(cm) {
                            app.saveContent();
                        },
                        'Cmd-S': function(cm) {
                            app.saveContent();
                        }
                    }
                });
                codemirrorEditor.setValue(defaultLoadedData.content || '');
                codemirrorEditor.on('change', function(cm) {
                    app.content = cm.getValue();
                });

                // Add paste event listener for image paste
                codemirrorEditor.getInputField().addEventListener('paste', function(e) {
                    app.handlePaste(e);
                });

            }

            //

            // set hint
            var hintInput = document.getElementById("new-post-hint");
            if (hintInput !== undefined && defaultLoadedData.newPostHintSlug !== undefined)
            {
                hintInput.value = defaultLoadedData.newPostHintSlug;
            }

            // Add Cmd+S / Ctrl+S keyboard shortcut for save
            // document.addEventListener('keydown', function(e) {
            //     if ((e.metaKey || e.ctrlKey) && e.key === 's') {
            //         e.preventDefault(); // Prevent browser save dialog
            //         if (app && app.saveContent) {
            //             app.saveContent();
            //         }
            //     }
            // });

        });


        function buildBreadCrumbNav() {
            var data = defaultLoadedData.breadCrumbs || [{ name: 'Home', href: '/' }];
            var navlinks = [];
            data.forEach(function(item) {
                var link = {};
                link.name = item.title || item.text || item.name || 'undefined';
                link.href = item.url || item.href || '#';
                navlinks.push(link);
            });
            return navlinks;
        }


        const { createApp } = Vue
        
        var app = createApp({
            delimiters: ['[[', ']]'],
            data() {
                return {
                    content: defaultLoadedData.content || '',
                    frontmatter: defaultLoadedData.frontmatter || '',
                    currentFile: defaultLoadedData.currentFile || 'untitled.md',
                    isPrivate: defaultLoadedData.isPrivate || false,
                    lastSaved: null,
                    distractionFree: false, // it bugs out if you set it true. so don't.
                    sidebarVisible: true,
                    isDragOver: false,
                    uploading: false,
                    uploadProgress: 0,
                    sidebarBelow: false,
                    editorWidth: 'normal',
                    searchQuery: '',
                    sections: {
                        navigation: true,
                        frontmatter: true,
                        fileupload: true,
                        search: true,
                        history: false
                    },
                    navLinks: [
                        ...buildBreadCrumbNav()
                    ],
                    navigationItems: [
                        // { name: 'Dashboard', href: '/admin', emoji: 'üìä' },
                        // { name: 'All Posts', href: '/admin/posts', emoji: 'üìù' },
                        // { name: 'Pages', href: '/admin/pages', emoji: 'üìÑ' },
                        // { name: 'Files', href: '/admin/files', emoji: 'üóÇÔ∏è' },
                        // { name: 'Preview', href: '/preview/untitled', target: '_blank', emoji: 'üëÅÔ∏è', primary: true }
                    ],
                    files: [],
                    pendingFiles: [],
                    searchResults: [
                        { id: 1, title: 'Getting Started' },
                        { id: 2, title: 'Features Overview' },
                        { id: 3, title: 'Configuration' },
                        { id: 4, title: 'API Documentation' },
                        { id: 5, title: 'Deployment Guide' },
                        { id: 6, title: 'Troubleshooting' }
                    ],
                    editorWidthOptions: {
                        narrow: {
                            label: 'Narrow',
                            icon: 'S',
                            containerClass: 'max-w-4xl'
                        },
                        normal: {
                            label: 'Normal', 
                            icon: 'M',
                            containerClass: 'max-w-7xl'
                        },
                        wide: {
                            label: 'Wide',
                            icon: 'L',
                            containerClass: 'max-w-none'
                        }
                    },
                    history: [],
                    historyLoading: false,
                    historyError: null
                }
            },
            computed: {
                editorPlaceholder() {
                    return `# Your markdown content here...

## Features
- Write in markdown
- Upload files via sidebar
- Search and link pages
- Live preview available

Start writing your content here. The editor is now centered with a fixed maximum width for better readability and focus.`
                },
                filteredSearchResults() {
                    if (!this.searchQuery.trim()) {
                        return this.searchResults
                    }
                    return this.searchResults.filter(result => 
                        result.title.toLowerCase().includes(this.searchQuery.toLowerCase())
                    )
                }
            },
            methods: {
                toggleSidebar() {
                    this.sidebarVisible = !this.sidebarVisible;
                    this.saveSidebarState()
                },
                toggleSidebarPosition() {
                    this.sidebarBelow = !this.sidebarBelow
                    this.saveSidebarState()
                },
                toggleDistractionFree() {
                    this.distractionFree = !this.distractionFree
                },
                cycleEditorWidth() {
                    const widthKeys = Object.keys(this.editorWidthOptions)
                    const currentIndex = widthKeys.indexOf(this.editorWidth)
                    const nextIndex = (currentIndex + 1) % widthKeys.length
                    this.editorWidth = widthKeys[nextIndex]
                    this.saveEditorWidthState()
                },
                async saveContent() {
                    await this.$nextTick(); // Ensure UI updates before saving
                    try {
                        const response = await fetch('/admin/edit-data?action=save', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                fullSlug: defaultLoadedData.fullSlug,
                                content: this.content,
                                frontmatter: this.frontmatter,
                                currentFile: this.currentFile,
                                isPrivate: this.isPrivate
                            })
                        });

                        const data = await response.json();

                        if (!response.ok || data.error) {
                            const errorMessage = data.error || `HTTP error! status: ${response.status}`;
                            throw new Error(errorMessage);
                        }

                        this.content = data.content || this.content;
                        this.frontmatter = data.frontmatter || this.frontmatter;
                        this.currentFile = data.currentFile || this.currentFile;
                        this.lastSaved = new Date().toLocaleTimeString();
                        
                        console.log('Content saved successfully!');
                        // alert('Content saved successfully!');

                        //await this.loadHistory(); // Refresh history after save
                        // load history asynchronously without blocking
                        this.loadHistory();

                    } catch (error) {
                        console.error('Error saving content:', error);
                        alert('Error saving content: ' + error.message);
                    }
                },
                toggleSection(section) {
                    this.sections[section] = !this.sections[section]
                    this.saveSectionStates();
                    
                    // Load history when history section is opened
                    if (section === 'history' && this.sections.history && this.history.length === 0) {
                        this.loadHistory();
                    }
                    
                    // Load files when file upload section is opened
                    if (section === 'fileupload' && this.sections.fileupload && this.files.length === 0) {
                        this.loadFiles();
                    }
                },
                autoResize(event) {
                    console.log("Auto resizing editor")
                    const textarea = event.target
                    textarea.style.height = 'auto'
                    console.log("Scroll height:", textarea.scrollHeight)
                    textarea.style.height = Math.max(CONFIG.EDITOR_MIN_HEIGHT, textarea.scrollHeight) + 'px'
                },
                triggerFileInput() {
                    this.$refs.fileInput.click()
                },
                handleFileSelect(event) {
                    const files = Array.from(event.target.files)
                    this.addPendingFiles(files)
                },
                handleDrop(event) {
                    event.preventDefault()
                    this.isDragOver = false
                    const files = Array.from(event.dataTransfer.files)
                    this.addPendingFiles(files)
                },
                addPendingFiles(files) {
                    files.forEach(file => {
                        const pendingFile = {
                            id: Date.now() + Math.random(),
                            name: file.name,
                            type: file.type.startsWith('image/') ? 'image' : 'file',
                            file: file, // Store the actual file object for upload
                            resizeWidth: file.type.startsWith('image/') ? CONFIG.DEFAULT_IMAGE_WIDTH.toString() : '',
                            resizeHeight: file.type.startsWith('image/') ? CONFIG.DEFAULT_IMAGE_HEIGHT.toString() : ''
                        }
                        this.pendingFiles.push(pendingFile)
                    })
                    // Clear the file input
                    this.$refs.fileInput.value = ''
                },
                removePendingFile(fileId) {
                    const index = this.pendingFiles.findIndex(f => f.id === fileId)
                    if (index > -1) {
                        this.pendingFiles.splice(index, 1)
                    }
                },
                async uploadPendingFiles() {
                    if (this.uploading || this.pendingFiles.length === 0) return
                    
                    this.uploading = true
                    this.uploadProgress = 0

                    // Process files individually to handle different resize dimensions
                    const uploadResults = []
                    
                    for (let i = 0; i < this.pendingFiles.length; i++) {
                        const pendingFile = this.pendingFiles[i]
                        this.uploadProgress = Math.round((i / this.pendingFiles.length) * 100)
                        
                        try {
                            const formData = new FormData()
                            formData.append('files', pendingFile.file)
                            formData.append('fullSlug', defaultLoadedData.fullSlug || '')
                            
                            // Add resize parameters if it's an image with dimensions
                            if (pendingFile.type === 'image') {
                                if (pendingFile.resizeWidth) {
                                    formData.append('width', pendingFile.resizeWidth.toString())
                                }
                                if (pendingFile.resizeHeight) {
                                    formData.append('height', pendingFile.resizeHeight.toString())
                                }
                            }

                            const response = await fetch('/admin/upload', {
                                method: 'POST',
                                body: formData
                            })

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`)
                            }

                            const data = await response.json()
                            uploadResults.push(...data.uploaded)
                            
                            // Get the actual uploaded filename from server response
                            const uploadedPath = data.uploaded[0] // Should be something like "/uploads/slug/filename.jpg"
                            const actualFilename = uploadedPath.split('/').pop() // Extract just the filename
                            
                            // Add to UI files with the actual filename
                            const newFile = {
                                id: Date.now() + Math.random(),
                                name: actualFilename,
                                type: pendingFile.type,
                                menuOpen: false,
                                resizeOpen: false,
                                resizeWidth: '',
                                resizeHeight: '',
                                uploaded: true
                            }
                            this.files.push(newFile)
                            
                            // Insert markdown for all uploaded images using the actual filename
                            if (pendingFile.type === 'image') {
                                // Use newline insertion for automatic uploads
                                this.insertImageWithNewlines(actualFilename, uploadedPath)
                            }
                            
                        } catch (error) {
                            console.error(`Error uploading file ${pendingFile.name}:`, error)
                            alert(`Error uploading file ${pendingFile.name}: ${error.message}`)
                            this.uploading = false
                            this.uploadProgress = 0
                            return
                        }
                    }

                    this.uploadProgress = 100
                    console.log('Files uploaded successfully:', uploadResults)
                    
                    // Clear pending files
                    this.pendingFiles = []
                    
                    this.uploading = false
                    this.uploadProgress = 0
                },
                async loadFiles() {
                    if (!defaultLoadedData.fullSlug) return

                    try {
                        const response = await fetch(`/admin/uploads-list?fullSlug=${encodeURIComponent(defaultLoadedData.fullSlug)}`)
                        
                        if (!response.ok) {
                            if (response.status === 404) {
                                // No files found, that's okay
                                return
                            }
                            throw new Error(`HTTP error! status: ${response.status}`)
                        }

                        const data = await response.json()
                        this.files = (data.files || []).map(file => ({
                            id: Date.now() + Math.random(),
                            name: file.name,
                            type: file.type,
                            menuOpen: false,
                            resizeOpen: false,
                            resizeWidth: '',
                            resizeHeight: '',
                            uploaded: true
                        }))
                        
                    } catch (error) {
                        console.error('Error loading files:', error)
                    }
                },
                toggleFileMenu(fileId) {
                    this.files.forEach(file => {
                        if (file.id !== fileId) {
                            file.menuOpen = false
                        }
                    })
                    const file = this.files.find(f => f.id === fileId)
                    if (file) {
                        file.menuOpen = !file.menuOpen
                    }
                },
                async renameFile(file) {
                    const newName = prompt('Enter new filename:', file.name)
                    if (!newName || !newName.trim() || newName.trim() === file.name) {
                        file.menuOpen = false
                        return
                    }

                    const trimmedName = newName.trim()

                    // Basic client-side validation
                    if (trimmedName.includes('/') || trimmedName.includes('\\') || trimmedName.includes('..')) {
                        alert('Invalid filename. Cannot contain /, \\, or ..')
                        file.menuOpen = false
                        return
                    }

                    // Check if filename already exists in current files
                    if (this.files.some(f => f.id !== file.id && f.name === trimmedName)) {
                        alert('A file with this name already exists')
                        file.menuOpen = false
                        return
                    }

                    try {
                        const response = await fetch('/admin/upload-rename', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                fullSlug: defaultLoadedData.fullSlug || '',
                                oldFilename: file.name,
                                newFilename: trimmedName
                            })
                        })

                        if (!response.ok) {
                            const error = await response.json()
                            throw new Error(error.error || `HTTP error! status: ${response.status}`)
                        }

                        // Update the filename in the UI only after successful server rename
                        file.name = trimmedName
                        console.log('File renamed successfully')

                    } catch (error) {
                        console.error('Error renaming file:', error)
                        alert('Error renaming file: ' + error.message)
                    }

                    file.menuOpen = false
                },
                async deleteFile(fileId) {
                    const file = this.files.find(f => f.id === fileId)
                    if (!file || !confirm('Are you sure you want to delete this file?')) return

                    try {
                        const response = await fetch('/admin/upload-delete', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                fullSlug: defaultLoadedData.fullSlug || '',
                                filename: file.name
                            })
                        })

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`)
                        }

                        // Remove from UI
                        const index = this.files.findIndex(f => f.id === fileId)
                        if (index > -1) {
                            this.files.splice(index, 1)
                        }

                    } catch (error) {
                        console.error('Error deleting file:', error)
                        alert('Error deleting file: ' + error.message)
                    }
                },
                toggleImageResize(fileId) {
                    const file = this.files.find(f => f.id === fileId)
                    if (file) {
                        file.resizeOpen = !file.resizeOpen
                        file.menuOpen = false
                    }
                },
                applyImageResize(file) {
                    const width = file.resizeWidth
                    const height = file.resizeHeight
                    const filePath = `/uploads/${defaultLoadedData.fullSlug || ''}/${file.name}`
                    let markdown = `![${file.name}](${filePath}`
                    if (width || height) {
                        // markdown += ` =${width || ''}x${height || ''}`
                    }
                    markdown += ')'
                    this.insertAtCursor(markdown)
                    file.resizeOpen = false
                },
                insertFileLink(file) {
                    const isImage = file.type === 'image'
                    const filePath = `/uploads/${defaultLoadedData.fullSlug || ''}/${file.name}`
                    const link = isImage ? `![${file.name}](${filePath})` : `[${file.name}](${filePath})`
                    this.insertAtCursor(link)
                },
                insertPageLink(page) {
                    const link = `[${page.title}](${page.title.toLowerCase().replace(/\s+/g, '-')})`
                    this.insertAtCursor(link)
                },
                insertAtCursor(text) {
                    // const textarea = document.getElementsByClassName("overtype-input")[0];
                    // const start = textarea.selectionStart
                    // const end = textarea.selectionEnd
                    //
                    // textarea.value = this.content.substring(0, start) + text + this.content.substring(end)
                    // this.$nextTick(() => {
                    //     textarea.focus()
                    //     textarea.setSelectionRange(start + text.length, start + text.length)
                    // })
                    const cursor = codemirrorEditor.getCursor();

                    // Insert text at cursor position
                    codemirrorEditor.replaceRange(text, cursor);

                    // Focus the editor
                    codemirrorEditor.focus();
                },


                insertAtCursorWithNewlines(text) {
                    // const textarea = document.getElementsByClassName("overtype-input")[0];
                    // const start = textarea.selectionStart
                    // const end = textarea.selectionEnd
                    //
                    // // Check if we need leading newline (not at start of line)
                    // const beforeCursor = this.content.substring(0, start);
                    // const needsLeadingNewline = beforeCursor.length > 0 && !beforeCursor.endsWith('\n');
                    //
                    // // Check if we need trailing newline (not followed by newline)
                    // const afterCursor = this.content.substring(end);
                    // const needsTrailingNewline = afterCursor.length > 0 && !afterCursor.startsWith('\n');
                    //
                    // // Build the text to insert with appropriate newlines
                    // let textToInsert = '';
                    // if (needsLeadingNewline) textToInsert += '\n';
                    // textToInsert += text;
                    // if (needsTrailingNewline) textToInsert += '\n';
                    //
                    // textarea.value = this.content.substring(0, start) + textToInsert + this.content.substring(end)
                    // this.$nextTick(() => {
                    //     textarea.focus()
                    //     textarea.setSelectionRange(start + textToInsert.length, start + textToInsert.length)
                    // })

                        const cursor = codemirrorEditor.getCursor();
                        const lineContent = codemirrorEditor.getLine(cursor.line);

                        // Check if we need leading newline (not at start of line)
                        const needsLeadingNewline = cursor.ch > 0 && lineContent.trim().length > 0;

                        // Check if we need trailing newline (not followed by newline)
                        const totalLines = codemirrorEditor.lineCount();
                        const isLastLine = cursor.line === totalLines - 1;
                        const nextLineEmpty = !isLastLine && codemirrorEditor.getLine(cursor.line + 1).trim() === '';
                        const needsTrailingNewline = !isLastLine && !nextLineEmpty;

                        // Build the text to insert with appropriate newlines
                        let textToInsert = '';
                        if (needsLeadingNewline) textToInsert += '\n';
                        textToInsert += text;
                        if (needsTrailingNewline) textToInsert += '\n';

                        // Insert text at cursor position
                        codemirrorEditor.replaceRange(textToInsert, cursor);

                        // Focus and set cursor position after inserted text
                        codemirrorEditor.focus();
                },
                insertImageWithNewlines(filename, uploadedPath) {
                    const markdown = `![${filename}](${uploadedPath})`;
                    this.insertAtCursorWithNewlines(markdown);
                },
                async handlePaste(event) {
                    const clipboardItems = event.clipboardData?.items;
                    if (!clipboardItems) return;

                    const imageFiles = [];

                    const MIME_TO_EXT = {
                        'image/png': 'png',
                        'image/jpeg': 'jpg',
                        'image/gif': 'gif',
                        'image/webp': 'webp',
                        'image/heic': 'heic',
                        'image/heif': 'heif'
                    };

                    function guessExtension(mime, fallback = 'png') {
                      if (!mime) return fallback;
                      const type = String(mime).toLowerCase().split(';', 1)[0].trim();
                      const direct = MIME_TO_EXT[type];
                      if (direct !== undefined) return direct;
                      if (type.includes('heic')) return 'heic';
                      if (type.includes('heif')) return 'heif';
                      return fallback;
                    }

                    // Check each clipboard item for images
                    for (let i = 0; i < clipboardItems.length; i++) {
                        const item = clipboardItems[i];
                        if (item.type.startsWith('image/')) {
                            const file = item.getAsFile();
                            console.log('Pasted image file:', file);
                            if (file) {
                                // Generate unique filename with timestamp
                                const timestamp = Date.now();
                                const extension = guessExtension(file.type, 'png');
                                console.log('Guessed extension:', extension);
                                const filename = `pasted-image-${timestamp}.${extension}`;
                                
                                // Create a new File object with our custom name
                                const namedFile = new File([file], filename, { type: file.type });
                                imageFiles.push(namedFile);
                            }
                        }
                    }

                    if (imageFiles.length > 0) {
                        // Prevent default paste behavior for images
                        event.preventDefault();
                        
                        // Add images as pending files
                        this.addPendingFiles(imageFiles);
                        
                        // Auto-upload the pasted images
                        await this.uploadPendingFiles();
                        
                        console.log(`Pasted and uploaded ${imageFiles.length} image(s)`);
                    }
                },
                performSearch() {
                    console.log('Searching for:', this.searchQuery)
                },
                updateFrontmatter(event) {
                    console.log('Frontmatter updated:', JSON.stringify(event.target.value))
                    this.frontmatter = event.target.value
                },
                async loadHistory() {
                    if (!defaultLoadedData.fullSlug) {
                        console.warn('No fullSlug available for history loading');
                        return;
                    }

                    this.historyLoading = true;
                    this.historyError = null;
                    // Keep existing history content visible during loading

                    try {
                        const response = await fetch(`/admin/edit-data?path=${encodeURIComponent(defaultLoadedData.fullSlug)}&action=history`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        // Only update history after successful load
                        this.history = (data.history || []).map(item => ({
                            ...item,
                            expanded: false
                        }));
                    } catch (error) {
                        console.error('Error loading history:', error);
                        this.historyError = 'Failed to load history: ' + error.message;
                        // Don't clear existing history on error
                    } finally {
                        this.historyLoading = false;
                    }
                },
                toggleHistoryItem(index) {
                    if (this.history[index]) {
                        this.history[index].expanded = !this.history[index].expanded;
                    }
                },
                formatDate(dateString) {
                    if (!dateString) return 'Unknown date';
                    try {
                        const date = new Date(dateString);
                        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    } catch (e) {
                        return dateString;
                    }
                },
                                // State persistence helpers
                saveSidebarState() {
                    if (typeof Storage !== 'undefined') {
                        localStorage.setItem('oddity-sidebar-visible', this.sidebarVisible)
                        localStorage.setItem('oddity-sidebar-below', this.sidebarBelow)
                    }
                },

                saveDistractionFreeState() {
                    if (typeof Storage !== 'undefined') {
                        localStorage.setItem('oddity-distraction-free', this.distractionFree)
                    }
                },

                saveSectionStates() {
                    if (typeof Storage !== 'undefined') {
                        localStorage.setItem('oddity-sections', JSON.stringify(this.sections))
                    }
                },

                saveEditorWidthState() {
                    if (typeof Storage !== 'undefined') {
                        localStorage.setItem('oddity-editor-width', this.editorWidth)
                    }
                },

                loadSavedStates() {
                    if (typeof Storage !== 'undefined') {
                        // Load sidebar state
                        const sidebarState = localStorage.getItem('oddity-sidebar-visible')
                        if (sidebarState !== null) {
                            this.sidebarVisible = sidebarState === 'true'
                        }
                        const sidebarBelowState = localStorage.getItem('oddity-sidebar-below')
                        if (sidebarBelowState !== null) {
                            this.sidebarBelow = sidebarBelowState === 'true'
                        }

                        // Load editor width state
                        const editorWidthState = localStorage.getItem('oddity-editor-width')
                        if (editorWidthState && this.editorWidthOptions[editorWidthState]) {
                            this.editorWidth = editorWidthState
                        }

                        // Load distraction-free state
                        const distractionFreeState = localStorage.getItem('oddity-distraction-free')
                        if (distractionFreeState !== null) {
                            this.distractionFree = distractionFreeState === 'true'
                        }

                        // Load section states
                        const sectionsState = localStorage.getItem('oddity-sections')
                        if (sectionsState) {
                            try {
                                this.sections = { ...this.sections, ...JSON.parse(sectionsState) }
                            } catch (e) {
                                console.warn('Failed to load section states:', e)
                            }
                        }
                    }
                }
            },
            mounted() {
                this.loadSavedStates()
                if (this.$refs.editor) {
                    this.autoResize({ target: this.$refs.editor })
                }
                this.$nextTick(() => {
                    console.log("Mounted, resizing editor")
                    if (this.$refs.editor) {
                        this.autoResize({ target: this.$refs.editor })
                    }
                    
                    // Auto-load history if section is open on page load
                    if (this.sections.history && this.history.length === 0) {
                        this.loadHistory();
                    }
                    
                    // Auto-load files if section is open on page load
                    if (this.sections.fileupload && this.files.length === 0) {
                        this.loadFiles();
                    }
                })
            },
        }).mount('#app')

        setTimeout(() => {
            if (app.$refs.editor) {
                app.autoResize({ target: app.$refs.editor })
            }
        }, 500);
    </script>
</body>
</html>