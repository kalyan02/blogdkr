<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oddity Editor - Fixed Layout</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/overtype/dist/overtype.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'mono': ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'pulse-once': 'pulse-once 1.5s ease-in-out'
                    },
                    keyframes: {
                        'pulse-once': {
                            '0%, 100%': { opacity: '0.5' },
                            '50%': { opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Diff HTML styling */
        .diff {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            line-height: 1.4;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        .diff-item {
            display: block;
        }
        
        .diff-insert {
            background-color: #d4edda;
            color: #155724;
            border-left: 3px solid #28a745;
            padding-left: 4px;
            margin: 0px 0;
            display: block;
        }
        
        .diff-delete {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 3px solid #dc3545;
            padding-left: 4px;
            margin: 0px 0;
            display: block;
        }
        
        .diff-equal {
            color: #6c757d;
            display: block;
            margin: 0px 0;
            padding-left: 4px;
        }

        .summary-gray {
            color: #6c757d;
            font-weight: bold;
        }
        .summary-inserts {
            color: #28a745;
            font-weight: bold;
        }
        .summary-deletes {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body class="font-mono bg-white min-h-screen">
    <div id="app">
        <!-- Navigation Bar -->
        <div class="py-1 border-b-0 border-gray-100">
            <div :class="'mx-auto px-2 pt-2 pb-2 flex flex-col lg:flex-row items-start lg:items-center lg:justify-between gap-2 ' + editorWidthOptions[editorWidth].containerClass">
                <!-- Left: Navigation Links -->
                <div class="flex gap-1 flex-wrap justify-center lg:justify-start" >
                    <a v-for="link in navLinks" :key="link.name" :href="link.href" :target="link.target"  v-if="!distractionFree"
                       class="text-gray-600 text-xs px-1 py-1 rounded hover:bg-gray-100 hover:text-gray-900 transition-colors"
                       :class="{ 'bg-blue-600 text-white hover:bg-blue-700 hover:text-white': link.primary }">
                        [[ link.name ]]
                    </a>
                    <span v-if="!distractionFree" class="text-xs text-gray-400 px-1 py-1 hidden lg:inline">|</span>
                    <input  v-if="!distractionFree" type="text" value="/{{.NewPostHintSlug}}" id="new-post-hint"
                      class="text-xs px-2 py-1 border border-gray-300 rounded bg-gray-50 text-gray-500 cursor-pointer w-full max-w-60 lg:w-60" />

                    <input  v-if="!distractionFree"  type="button" value="Add"
                      onclick="location.href='/admin/edit?path=' + document.getElementById('new-post-hint').value"
                      class="text-xs px-2 py-1 border border-gray-300 rounded bg-gray-100 text-gray-600 hover:bg-gray-200 cursor-pointer" />
                    <a  v-if="!distractionFree" href="/auth" class="text-xs px-2 py-1 border border-gray-300 rounded bg-gray-100 text-gray-600 hover:bg-gray-200 cursor-pointer">
                        Auth
                    </a>
                    <a  v-if="!distractionFree" href="/auth/logout" class="text-xs px-2 py-1 border border-gray-300 rounded bg-gray-100 text-gray-600 hover:bg-gray-200 cursor-pointer">
                        Logout
                    </a>
                </div>

                <!-- Right: Controls -->
                <div class="flex gap-1 justify-center">
                    <button @click="toggleSidebar"
                            class="bg-white border border-gray-300 rounded px-2 py-1 text-xs text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all">
                        [[ sidebarVisible ? '‚úï' : '‚â°' ]]
                    </button>
                    <button @click="toggleSidebarPosition"
                            class="bg-white border border-gray-300 rounded px-2 py-1 text-xs text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all"
                            title="Move sidebar below content">
                        [[ sidebarBelow ? '‚Üë' : '‚Üì' ]]
                    </button>
                    <button @click="cycleEditorWidth"
                            class="bg-white border border-gray-300 rounded px-2 py-1 text-xs text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all"
                            :title="'Editor width: ' + editorWidthOptions[editorWidth].label">
                        [[ editorWidthOptions[editorWidth].icon ]]
                    </button>
                    <button @click="toggleDistractionFree"
                            class="bg-white border border-gray-300 rounded px-2 py-1 text-xs text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all">
                        [[ distractionFree ? '‚óë' : '‚óê' ]]
                    </button>
                    <button @click="saveContent"
                            class="bg-white border border-gray-300 rounded px-2 py-1 text-xs text-green-600 hover:text-white hover:bg-green-600 transition-all">
                        üíæ
                    </button>
                </div>
            </div>
        </div>

        <!-- Title Bar -->
        <div class="py-4">
            <div :class="'mx-auto px-4 ' + editorWidthOptions[editorWidth].containerClass">
                <span class="text-sm text-gray-500" :class="{ 'text-gray-200 hover:text-gray-500': distractionFree }">Editing: [[ currentFile ]]</span>
                <span v-if="lastSaved" :key="lastSaved" class="text-xs text-gray-500 ml-4 animate-pulse-once">Last saved: [[ lastSaved ]]</span>
            </div>
        </div>

        <!-- Main Content -->
        <div :class="'mx-auto px-4 flex flex-col gap-6 ' + editorWidthOptions[editorWidth].containerClass + (!sidebarBelow ? ' lg:flex-row' : ' lg:flex-col')">
            <!-- Editor Area -->
            <div class="flex-1 border-t border-solid" :class="{ 'border-gray-100': distractionFree, 'border-gray-300': !distractionFree }">
                <div id="richeditor" class="w-full richeditor"></div>

            </div>

            <!-- Sidebar -->
            <div v-if="sidebarVisible && !distractionFree" 
                 class="w-full flex-shrink-0 border-t pt-6" 
                 :class="{ 
                     'lg:w-64 lg:border-t-0 lg:pt-0': !sidebarBelow,
                     'lg:w-full lg:mx-auto lg:border-t lg:pt-6': sidebarBelow
                 }">
                
                <!-- Navigation Section -->
                <div class="mb-6">
                    <h3 @click="toggleSection('navigation')" 
                        class="text-xs uppercase text-gray-600 font-semibold mb-3 cursor-pointer flex items-center justify-between hover:text-gray-900">
                        Navigation
                        <span class="text-xs transition-transform" :class="{ 'rotate-180': !sections.navigation }">‚ñº</span>
                    </h3>
                    <div v-show="sections.navigation" class="space-y-1">
                        <a v-for="navItem in navigationItems" :key="navItem.name" :href="navItem.href" :target="navItem.target"
                           class="block text-gray-600 text-xs px-2 py-1 rounded hover:bg-gray-100 hover:text-gray-900 transition-colors no-underline"
                           :class="{ 'bg-blue-600 text-white hover:bg-blue-700 hover:text-white': navItem.primary }">
                            [[ navItem.emoji ]] [[ navItem.name ]]
                        </a>
                    </div>
                </div>

                <!-- Front Matter Section -->
                <div class="mb-6">
                    <h3 @click="toggleSection('frontmatter')" 
                        class="text-xs uppercase text-gray-600 font-semibold mb-3 cursor-pointer flex items-center justify-between hover:text-gray-900">
                        Front Matter
                        <span class="text-xs transition-transform" :class="{ 'rotate-180': !sections.frontmatter }">‚ñº</span>
                    </h3>
                    <div v-show="sections.frontmatter">
                        <textarea v-model="frontmatter"
                                  class="w-full h-24 text-xs border border-gray-200 p-2 font-mono resize-y outline-none bg-gray-50 focus:border-blue-500 rounded"
                                  placeholder="title: My Post&#10;tags: [blog, markdown]&#10;date: 2024-01-01&#10;public: true">
                        </textarea>
                    </div>
                </div>

                <!-- File Upload Section -->
                <div class="mb-6">
                    <h3 @click="toggleSection('fileupload')" 
                        class="text-xs uppercase text-gray-600 font-semibold mb-3 cursor-pointer flex items-center justify-between hover:text-gray-900">
                        File Upload
                        <span class="text-xs transition-transform" :class="{ 'rotate-180': !sections.fileupload }">‚ñº</span>
                    </h3>
                    <div v-show="sections.fileupload">
                        <!-- Upload Area -->
                        <div @click="triggerFileInput" @drop="handleDrop" @dragover.prevent @dragenter.prevent @dragleave.prevent
                             class="border-2 border-dashed border-gray-300 p-3 text-center text-gray-600 mb-3 cursor-pointer bg-gray-50 text-xs hover:border-blue-500 hover:bg-blue-50 transition-colors rounded"
                             :class="{ 'border-blue-500 bg-blue-50 text-blue-600': isDragOver }">
                            Drop files here or click to upload
                        </div>
                        <input ref="fileInput" type="file" multiple class="hidden" @change="handleFileSelect">
                        
                        <!-- File List -->
                        <div class="space-y-1">
                            <div v-for="file in files" :key="file.id" class="group">
                                <div class="flex items-center justify-between p-1 hover:bg-gray-50 rounded">
                                    <span @click="insertFileLink(file)" class="text-xs cursor-pointer flex-1 text-gray-700 hover:text-gray-900">
                                        <span class="font-semibold" :class="{ 'text-blue-600': file.type === 'image', 'text-gray-600': file.type === 'file' }">
                                            [[ file.type === 'image' ? '[IMG]' : '[FILE]' ]]
                                        </span>
                                        [[ file.name ]]
                                    </span>
                                    <button @click="toggleFileMenu(file.id)" 
                                            class="text-xs text-gray-400 hover:text-gray-600 px-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        ‚ãØ
                                    </button>
                                </div>
                                
                                <!-- File Menu -->
                                <div v-show="file.menuOpen" class="mt-1 bg-gray-50 border border-gray-200 rounded p-1">
                                    <div @click="renameFile(file)" class="text-xs p-2 cursor-pointer hover:bg-gray-100 border-b border-gray-100">Rename</div>
                                    <div @click="deleteFile(file.id)" class="text-xs p-2 cursor-pointer hover:bg-gray-100 text-red-600" :class="{ 'border-b border-gray-100': file.type === 'image' }">Delete</div>
                                    <div v-if="file.type === 'image'" @click="toggleImageResize(file.id)" class="text-xs p-2 cursor-pointer hover:bg-gray-100">
                                        [[ file.resizeOpen ? 'Hide Resize' : 'Resize' ]]
                                    </div>
                                </div>

                                <!-- Image Resize Controls -->
                                <div v-if="file.type === 'image' && file.resizeOpen" class="mt-1 p-2 bg-gray-50 rounded border border-gray-200">
                                    <div class="flex gap-1 items-center">
                                        <input v-model="file.resizeWidth" type="number" placeholder="Width" class="w-16 p-1 border border-gray-300 rounded text-xs">
                                        <input v-model="file.resizeHeight" type="number" placeholder="Height" class="w-16 p-1 border border-gray-300 rounded text-xs">
                                        <button @click="applyImageResize(file)" class="px-2 py-1 bg-blue-600 text-white border-none rounded text-xs cursor-pointer hover:bg-blue-700">Apply</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Page Search Section -->
                <div class="mb-6">
                    <h3 @click="toggleSection('search')" 
                        class="text-xs uppercase text-gray-600 font-semibold mb-3 cursor-pointer flex items-center justify-between hover:text-gray-900">
                        Page Search
                        <span class="text-xs transition-transform" :class="{ 'rotate-180': !sections.search }">‚ñº</span>
                    </h3>
                    <div v-show="sections.search">
                        <input v-model="searchQuery" @input="performSearch" type="text" placeholder="Search pages..." 
                               class="w-full p-2 border border-gray-200 text-xs font-mono outline-none bg-gray-50 focus:border-blue-500 rounded mb-3">
                        
                        <div class="space-y-1">
                            <div v-for="result in filteredSearchResults" :key="result.id" @click="insertPageLink(result)"
                                 class="text-xs p-1 cursor-pointer hover:bg-gray-50 rounded text-gray-700 hover:text-gray-900">
                                <span class="font-semibold text-green-600">[PAGE]</span>
                                [[ result.title ]]
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Diffs Section -->
                <div class="mb-6">
                    <h3 @click="toggleSection('history')" 
                        class="text-xs uppercase text-gray-600 font-semibold mb-3 cursor-pointer flex items-center justify-between hover:text-gray-900">
                        History
                        <span class="text-xs transition-transform" :class="{ 'rotate-180': !sections.history }">‚ñº</span>
                    </h3>
                    <div v-show="sections.history">
                        <div v-if="historyLoading" class="text-xs text-gray-500 p-2">Loading history...</div>
                        <div v-else-if="historyError" class="text-xs text-red-500 p-2">[[ historyError ]]</div>
                        <div v-else-if="history.length === 0" class="text-xs text-gray-500 p-2">No history available</div>
                        <div v-else class="space-y-2">
                            <div v-for="(item, index) in history" :key="index" class="border border-gray-200 rounded">
                                <div @click="toggleHistoryItem(index)" 
                                     class="p-3 cursor-pointer hover:bg-gray-50 flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="text-xs font-medium text-gray-800">[[ item.title || 'Change' ]]</div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            [[ formatDate(item.createdAt) ]]
                                            <span v-if="item.deltaSummary" class="ml-2" v-html="item.deltaSummary"></span>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-400 transition-transform" 
                                          :class="{ 'rotate-180': item.expanded }">‚ñº</span>
                                </div>
                                <div v-show="item.expanded" class="border-t border-gray-200 p-3 bg-gray-50">
                                    <div v-if="item.diffHTML" v-html="item.diffHTML" class="text-xs font-mono overflow-x-auto"></div>
                                    <div v-else class="text-xs text-gray-500">No diff available</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <script>

        function tryJSON(input, defaultObj) {
            if (input === "") {
                return defaultObj
            }
            try {
                return JSON.parse(input)
            } catch (e) {
                console.log("Error parsing json", e)
                return defaultObj
            }
        }


        var defaultLoadedData = tryJSON("{{.Data}}", {});


        var editor = null;
        // document on load
        document.addEventListener("DOMContentLoaded", function() {
            // Create a single editor
            const OT = window.OverType.default || window.OverType;
            if(document.getElementsByClassName("richeditor").length > 0) {
                // document.getElementsByClassName("editorboxreal")[0].style.display = 'none';
                editor = new OT(".richeditor", {
                    value: defaultLoadedData.content || '',
                    theme: "light",
                    autoResize: true,
                    fontSize: '14px',
                    minHeight: '600px',
                    onChange: (value) => {
                        app.content = value;
                    }
                })
            }

            // set hint
            var hintInput = document.getElementById("new-post-hint");
            if (hintInput !== undefined && defaultLoadedData.newPostHintSlug !== undefined)
            {
                hintInput.value = defaultLoadedData.newPostHintSlug;
            }

        });


        function buildBreadCrumbNav() {
            var data = defaultLoadedData.breadCrumbs || [{ name: 'Home', href: '/' }];
            var navlinks = [];
            data.forEach(function(item) {
                var link = {};
                link.name = item.title || item.text || item.name || 'undefined';
                link.href = item.url || item.href || '#';
                navlinks.push(link);
            });
            return navlinks;
        }


        const { createApp } = Vue
        
        var app = createApp({
            delimiters: ['[[', ']]'],
            data() {
                return {
                    content: defaultLoadedData.content || '',
                    frontmatter: defaultLoadedData.frontmatter || '',
                    currentFile: defaultLoadedData.currentFile || 'untitled.md',
                    lastSaved: null,
                    distractionFree: false,
                    sidebarVisible: true,
                    isDragOver: false,
                    sidebarBelow: false,
                    editorWidth: 'normal',
                    searchQuery: '',
                    sections: {
                        navigation: true,
                        frontmatter: true,
                        fileupload: true,
                        search: true,
                        history: false
                    },
                    navLinks: [
                        ...buildBreadCrumbNav()
                    ],
                    navigationItems: [
                        // { name: 'Dashboard', href: '/admin', emoji: 'üìä' },
                        // { name: 'All Posts', href: '/admin/posts', emoji: 'üìù' },
                        // { name: 'Pages', href: '/admin/pages', emoji: 'üìÑ' },
                        // { name: 'Files', href: '/admin/files', emoji: 'üóÇÔ∏è' },
                        { name: 'Preview', href: '/preview/untitled', target: '_blank', emoji: 'üëÅÔ∏è', primary: true }
                    ],
                    files: [
                        { id: 1, name: 'image1.jpg', type: 'image', menuOpen: false, resizeOpen: false, resizeWidth: '', resizeHeight: '' },
                        { id: 2, name: 'document.pdf', type: 'file', menuOpen: false },
                        { id: 3, name: 'screenshot.png', type: 'image', menuOpen: false, resizeOpen: false, resizeWidth: '', resizeHeight: '' }
                    ],
                    searchResults: [
                        { id: 1, title: 'Getting Started' },
                        { id: 2, title: 'Features Overview' },
                        { id: 3, title: 'Configuration' },
                        { id: 4, title: 'API Documentation' },
                        { id: 5, title: 'Deployment Guide' },
                        { id: 6, title: 'Troubleshooting' }
                    ],
                    editorWidthOptions: {
                        narrow: {
                            label: 'Narrow',
                            icon: 'S',
                            containerClass: 'max-w-4xl'
                        },
                        normal: {
                            label: 'Normal', 
                            icon: 'M',
                            containerClass: 'max-w-7xl'
                        },
                        wide: {
                            label: 'Wide',
                            icon: 'L',
                            containerClass: 'max-w-none'
                        }
                    },
                    history: [],
                    historyLoading: false,
                    historyError: null
                }
            },
            computed: {
                editorPlaceholder() {
                    return `# Your markdown content here...

## Features
- Write in markdown
- Upload files via sidebar
- Search and link pages
- Live preview available

Start writing your content here. The editor is now centered with a fixed maximum width for better readability and focus.`
                },
                filteredSearchResults() {
                    if (!this.searchQuery.trim()) {
                        return this.searchResults
                    }
                    return this.searchResults.filter(result => 
                        result.title.toLowerCase().includes(this.searchQuery.toLowerCase())
                    )
                }
            },
            methods: {
                toggleSidebar() {
                    this.sidebarVisible = !this.sidebarVisible;
                    this.saveSidebarState()
                },
                toggleSidebarPosition() {
                    this.sidebarBelow = !this.sidebarBelow
                    this.saveSidebarState()
                },
                toggleDistractionFree() {
                    this.distractionFree = !this.distractionFree
                },
                cycleEditorWidth() {
                    const widthKeys = Object.keys(this.editorWidthOptions)
                    const currentIndex = widthKeys.indexOf(this.editorWidth)
                    const nextIndex = (currentIndex + 1) % widthKeys.length
                    this.editorWidth = widthKeys[nextIndex]
                    this.saveEditorWidthState()
                },
                async saveContent() {
                    try {
                        const response = await fetch('/admin/edit-data?action=save', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                fullSlug: defaultLoadedData.fullSlug,
                                content: this.content,
                                frontmatter: this.frontmatter,
                                currentFile: this.currentFile
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const updatedData = await response.json();
                        
                        this.content = updatedData.content || this.content;
                        this.frontmatter = updatedData.frontmatter || this.frontmatter;
                        this.currentFile = updatedData.currentFile || this.currentFile;
                        this.lastSaved = new Date().toLocaleTimeString();
                        
                        console.log('Content saved successfully!');
                        // alert('Content saved successfully!');
                    } catch (error) {
                        console.error('Error saving content:', error);
                        alert('Error saving content: ' + error.message);
                    }
                },
                toggleSection(section) {
                    this.sections[section] = !this.sections[section]
                    this.saveSectionStates();
                    
                    // Load history when history section is opened
                    if (section === 'history' && this.sections.history && this.history.length === 0) {
                        this.loadHistory();
                    }
                },
                autoResize(event) {
                    console.log("Auto resizing editor")
                    const textarea = event.target
                    textarea.style.height = 'auto'
                    console.log("Scroll height:", textarea.scrollHeight)
                    textarea.style.height = Math.max(600, textarea.scrollHeight) + 'px'
                },
                triggerFileInput() {
                    this.$refs.fileInput.click()
                },
                handleFileSelect(event) {
                    const files = Array.from(event.target.files)
                    files.forEach(file => this.addFile(file))
                },
                handleDrop(event) {
                    event.preventDefault()
                    this.isDragOver = false
                    const files = Array.from(event.dataTransfer.files)
                    files.forEach(file => this.addFile(file))
                },
                addFile(file) {
                    const newFile = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        type: file.type.startsWith('image/') ? 'image' : 'file',
                        menuOpen: false,
                        resizeOpen: false,
                        resizeWidth: '',
                        resizeHeight: ''
                    }
                    this.files.push(newFile)
                },
                toggleFileMenu(fileId) {
                    this.files.forEach(file => {
                        if (file.id !== fileId) {
                            file.menuOpen = false
                        }
                    })
                    const file = this.files.find(f => f.id === fileId)
                    if (file) {
                        file.menuOpen = !file.menuOpen
                    }
                },
                renameFile(file) {
                    const newName = prompt('Enter new filename:', file.name)
                    if (newName && newName.trim()) {
                        file.name = newName.trim()
                    }
                    file.menuOpen = false
                },
                deleteFile(fileId) {
                    if (confirm('Are you sure you want to delete this file?')) {
                        const index = this.files.findIndex(f => f.id === fileId)
                        if (index > -1) {
                            this.files.splice(index, 1)
                        }
                    }
                },
                toggleImageResize(fileId) {
                    const file = this.files.find(f => f.id === fileId)
                    if (file) {
                        file.resizeOpen = !file.resizeOpen
                        file.menuOpen = false
                    }
                },
                applyImageResize(file) {
                    const width = file.resizeWidth
                    const height = file.resizeHeight
                    let markdown = `![${file.name}](${file.name}`
                    if (width || height) {
                        markdown += ` =${width || ''}x${height || ''}`
                    }
                    markdown += ')'
                    this.insertAtCursor(markdown)
                    file.resizeOpen = false
                },
                insertFileLink(file) {
                    const isImage = file.type === 'image'
                    const link = isImage ? `![${file.name}](${file.name})` : `[${file.name}](${file.name})`
                    this.insertAtCursor(link)
                },
                insertPageLink(page) {
                    const link = `[${page.title}](${page.title.toLowerCase().replace(/\s+/g, '-')})`
                    this.insertAtCursor(link)
                },
                insertAtCursor(text) {
                    const textarea = document.getElementsByClassName("overtype-input")[0];
                    const start = textarea.selectionStart
                    const end = textarea.selectionEnd
                    
                    textarea.value = this.content.substring(0, start) + text + this.content.substring(end)
                    this.$nextTick(() => {
                        textarea.focus()
                        textarea.setSelectionRange(start + text.length, start + text.length)
                    })
                },
                performSearch() {
                    console.log('Searching for:', this.searchQuery)
                },
                async loadHistory() {
                    if (!defaultLoadedData.fullSlug) {
                        console.warn('No fullSlug available for history loading');
                        return;
                    }

                    this.historyLoading = true;
                    this.historyError = null;

                    try {
                        const response = await fetch(`/admin/edit-data?path=${encodeURIComponent(defaultLoadedData.fullSlug)}&action=history`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        this.history = (data.history || []).map(item => ({
                            ...item,
                            expanded: false
                        }));
                    } catch (error) {
                        console.error('Error loading history:', error);
                        this.historyError = 'Failed to load history: ' + error.message;
                    } finally {
                        this.historyLoading = false;
                    }
                },
                toggleHistoryItem(index) {
                    if (this.history[index]) {
                        this.history[index].expanded = !this.history[index].expanded;
                    }
                },
                formatDate(dateString) {
                    if (!dateString) return 'Unknown date';
                    try {
                        const date = new Date(dateString);
                        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    } catch (e) {
                        return dateString;
                    }
                },
                                // State persistence helpers
                saveSidebarState() {
                    if (typeof Storage !== 'undefined') {
                        localStorage.setItem('oddity-sidebar-visible', this.sidebarVisible)
                        localStorage.setItem('oddity-sidebar-below', this.sidebarBelow)
                    }
                },

                saveDistractionFreeState() {
                    if (typeof Storage !== 'undefined') {
                        localStorage.setItem('oddity-distraction-free', this.distractionFree)
                    }
                },

                saveSectionStates() {
                    if (typeof Storage !== 'undefined') {
                        localStorage.setItem('oddity-sections', JSON.stringify(this.sections))
                    }
                },

                saveEditorWidthState() {
                    if (typeof Storage !== 'undefined') {
                        localStorage.setItem('oddity-editor-width', this.editorWidth)
                    }
                },

                loadSavedStates() {
                    if (typeof Storage !== 'undefined') {
                        // Load sidebar state
                        const sidebarState = localStorage.getItem('oddity-sidebar-visible')
                        if (sidebarState !== null) {
                            this.sidebarVisible = sidebarState === 'true'
                        }
                        const sidebarBelowState = localStorage.getItem('oddity-sidebar-below')
                        if (sidebarBelowState !== null) {
                            this.sidebarBelow = sidebarBelowState === 'true'
                        }

                        // Load editor width state
                        const editorWidthState = localStorage.getItem('oddity-editor-width')
                        if (editorWidthState && this.editorWidthOptions[editorWidthState]) {
                            this.editorWidth = editorWidthState
                        }

                        // Load distraction-free state
                        const distractionFreeState = localStorage.getItem('oddity-distraction-free')
                        if (distractionFreeState !== null) {
                            this.distractionFree = distractionFreeState === 'true'
                        }

                        // Load section states
                        const sectionsState = localStorage.getItem('oddity-sections')
                        if (sectionsState) {
                            try {
                                this.sections = { ...this.sections, ...JSON.parse(sectionsState) }
                            } catch (e) {
                                console.warn('Failed to load section states:', e)
                            }
                        }
                    }
                }
            },
            mounted() {
                this.loadSavedStates()
                if (this.$refs.editor) {
                    this.autoResize({ target: this.$refs.editor })
                }
                this.$nextTick(() => {
                    console.log("Mounted, resizing editor")
                    if (this.$refs.editor) {
                        this.autoResize({ target: this.$refs.editor })
                    }
                    
                    // Auto-load history if section is open on page load
                    if (this.sections.history && this.history.length === 0) {
                        this.loadHistory();
                    }
                })
            },
        }).mount('#app')

        setTimeout(() => {
            if (app.$refs.editor) {
                app.autoResize({ target: app.$refs.editor })
            }
        }, 500);
    </script>
</body>
</html>