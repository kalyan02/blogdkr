# Caddyfile: PHP + static with strict 404s

devnet.lonefish.net, devnet2.lonefish.net {
	tls letsencrypt@namburi.org

	log {
		output file /var/log/caddy/access.log {
			roll_size 10MB
			roll_keep 5
		}
		format json
	}

	header {
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		X-XSS-Protection "1; mode=block"
		Server "Caddy/BlogSync"
	}

	# API
	handle /health {
		reverse_proxy localhost:3000
	}
	handle /webhook {
		reverse_proxy localhost:3000
	}
	handle /auth/* {
		reverse_proxy localhost:3000
	}

	# Everything else
	handle {
		# 1) Static from /var/www/sync (never serve .php)
		@sync_static {
			not {
				path *.php
			}
			file {
				root /var/www/sync
				try_files {path} {path}/index.html
			}
		}
		handle @sync_static {
			root * /var/www/sync
			file_server
		}

		# 2) Direct .php files under /var/www/html
		@php_file path *.php
		handle @php_file {
			root * /var/www/html
			php_fastcgi localhost:9000 {
				# disable fallback to /index.php
				try_files {path} =404
			}
		}

		# 3) Directories that contain index.php (serve for /dir or /dir/)
		@php_dir {
			file {
				root /var/www/html
				try_files {path}/index.php
			}
		}
		handle @php_dir {
			rewrite * {path}/index.php
			root * /var/www/html
			php_fastcgi localhost:9000 {
				try_files {path} =404
			}
		}

		# 4) Static from /var/www/html (never serve .php)
		@html_static {
			not {
				path *.php
			}
			file {
				root /var/www/html
				try_files {path} {path}/index.html
			}
		}
		handle @html_static {
			root * /var/www/html
			file_server
		}

		# 5) Nothing matched
		respond 404
	}
}

:80 {
	log {
		output file /var/log/caddy/access_http.log {
			roll_size 10MB
			roll_keep 5
		}
		format json
	}

	header {
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		X-XSS-Protection "1; mode=block"
		Server "Caddy/BlogSync"
	}

	# API
	handle /health {
		reverse_proxy localhost:3000
	}
	handle /webhook {
		reverse_proxy localhost:3000
	}
	handle /auth/* {
		reverse_proxy localhost:3000
	}

	# Everything else
	handle {
		@sync_static {
			not {
				path *.php
			}
			file {
				root /var/www/sync
				try_files {path} {path}/index.html
			}
		}
		handle @sync_static {
			root * /var/www/sync
			file_server
		}

		@php_file path *.php
		handle @php_file {
			root * /var/www/html
			php_fastcgi localhost:9000 {
				try_files {path} =404
			}
		}

		@php_dir {
			file {
				root /var/www/html
				try_files {path}/index.php
			}
		}
		handle @php_dir {
			rewrite * {path}/index.php
			root * /var/www/html
			php_fastcgi localhost:9000 {
				try_files {path} =404
			}
		}

		@html_static {
			not {
				path *.php
			}
			file {
				root /var/www/html
				try_files {path} {path}/index.html
			}
		}
		handle @html_static {
			root * /var/www/html
			file_server
		}

		respond 404
	}
}
