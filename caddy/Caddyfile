# ---------- reusable snippets ----------
(security_headers) {
	header {
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		X-XSS-Protection "1; mode=block"
		#Server "Caddy/BlogSync"
	}
}

(app_routes) {
	# API first
	# handle /health {
	# 	reverse_proxy localhost:3000
	# }
	# handle /webhook {
	# 	reverse_proxy localhost:3000
	# }
	# handle /auth/* {
	# 	reverse_proxy localhost:3000
	# }

	# Everything else
	handle {
		root * /var/www/html

		# Handle .php files and directories with index.php
		php_fastcgi php:9000 {
			try_files {path} {path}/index.php =404
		}

		# Serve static files, hide .php from being served as plain files
		file_server {
			hide *.php
		}

		# If no static file or PHP file found, proxy to oddity
		@not_found {
			not file {path}
			not file {path}/index.php
		}
		handle @not_found {
			reverse_proxy oddity:8081
		}
	}
}

(logging) {
	log {
		output file /var/log/caddy/access.log {
			roll_size 10MB
			roll_keep 5
		}
		level DEBUG
		format json {
			time_format "2006-01-02T15:04:05.000Z07:00"
			time_key "timestamp"
			message_key "message"
		}
	}
}

# ---------- end snippets ----------

# TLS sites
# devnet.lonefish.net, devnet2.lonefish.net {
# 	tls letsencrypt@namburi.org

# 	import logging
# 	import security_headers
# 	import app_routes
# }

# Plain HTTP

http://kalyanchakravarthy.net, http://www.kalyanchakravarthy.net {
	import logging
	import security_headers
	redir /pages/about.html https://namburi.org/about/
	redir https://namburi.org{uri}
}

namburi.org:80 {
	import logging
	import security_headers
	import app_routes
}
